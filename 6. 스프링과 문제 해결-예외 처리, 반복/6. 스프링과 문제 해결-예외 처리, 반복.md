## 스프링과 문제 해결 - 예외 처리, 반복

### 체크 예외와 인터페이스

- 서비스 계층은 가급적 특정 구현 기술에 의존하지 않고, 순수하게 유지하는 것이 좋음. 이렇게 하려면 예외에 대한 의존도 함께 해결해야 함.

- 예를 들어서 서비스가 처리할 수 없는 `SQLException`에 대한 의존을 제거하려면 어떻게 해야할까?

  → 서비스가 처리할 수 없으므로 리포지토리가 던지는 `SQLException` 체크 예외를 런타임 예외로 전환해서 서비스 계층에 던지기. 이렇게 하면 서비스 계층이 해당 예외를 무시할 수 있기 때문에, 특정 구현 기술에 의존하는 부분을 제거하고 서비스 계층을 순수하게 유지학 수 있음.

---

### 런타임 예외 적용

- 관련 코드는 github 소스 코드 참고 (MemberRepositoryV4_1)

  → 예외 누수 문제 해결

  → 체크 예외를 런타임 예외로 변경

  → MemberRepository 인터페이스 사용

  → throws SQLException 제거

- 주의점!

  → 예외를 변환할 때는 기존 예외를 꼭 포함하자! 장애가 발생하고 로그에서 진짜 원인이 남지 않는 심각한 문제가 발생할 수 있음.

---

### 데이터 접근 예외 직접 만들기

- 데이터베이스 오류에 따라서 특정 예외는 복구하고 싶을 수 있음.

- 관련 코드는 github 소스 코드 참고 (MyDuplicateKeyException, ExTranslatorV1Test)

- SQL ErrorCode로 데이터베이스에 어떤 오류가 있는지 확인할 수 있음.

- 예외 변환을 통해 `SQLException`을 특정 기술에 의존하지 않는 직접 만든 예외인 `MyDuplicateKeyException`로 변환할 수 있었음.

- 리포지토리 계층이 예외를 변환해준 덕분에 서비스 계층은 특정 기술에 의존하지 않는 `MyDuplicateKeyException`을 사용해서 문제를 복구하고, 서비스 계층의 순수성도 유지할 수 있었음.

---

### 스프링 예외 추상화 이해

- 스프링은 데이터 접근 계층에 대한 수십 가지 예외를 정리해서 일관된 예외 계층을 제공함.

- 각각의 예외는 특정 기술에 종속적이지 않게 설계되어 있어 서비스 계층에서도 스프링이 제공하는 예외를 사용하면 됨.

- JDBC나 JPA를 사용할 때 발생하는 예외를 스프링이 제공하는 예외로 변환해주는 역할도 스프링이 제공함.

- 예외의 최고 상위는 `org.springframework.dao.DataAccessException`임. 이것은 런타임 예외를 상속 받았기 때문에 스프링이 제공하는 데이터 접근 계층의 모든 예외는 런타임 예외임.

- `DataAccessException`은 크게 2가지로 구분하는데 `NonTransient` 예외와 `Transient` 예외임.

- `Transient`는 일시적이라는 뜻으로 Transient의 하위 예외는 동일한 SQL을 다시 시도했을 때 성공할 가능성이 있음. 예를 들어서 쿼리 타임아웃, 락과 관련된 오류들임.

- `NonTransient`는 일시적이지 않다는 뜻으로 같은 SQL을 그대로 반복해서 실행하면 실패함. 예를 들어서 SQL 문법 오류, 데이터베이스 제약조건 위배 등이 있음.

- 스프링은 예외 변환기를 통해서 `SQLException`의 `ErrorCode`에 맞는 적절한 스프링 데이터 접근 예외로 변환해줌.

- 관련 코드는 github 소스 코드 참고 (SpringExceptionTranslatorTest)

---

### 스프링 예외 추상화 적용

- 관련 코드는 github 소스 코드 참고 (MemberRepositoryV4_2)

---

### JDBC 반복 문제 해결 - JdbcTemplate

- JDBC 반복 문제

  → 커넥션 조회, 커넥션 동기화

  → `PreparedStatement` 생성 및 파라미터 바인딩

  → 쿼리 실행

  → 결과 바인딩

  → 예외 발생시 스프링 예외 변환기 실행

  → 리소스 종료

- 스프링은 JDBC의 반복 문제를 해결하기 위해 `JdbcTemplate`이라는 템플릿을 제공함.

- JdbcTemplate은 JDBC로 개발할 때 발생하는 반복을 대부분 해결해줌. 뿐만 아니라 트랜잭션을 위한 커넥션 동기화는 물론이고, 예외 발생시 스프링 예외 변환기도 자동으로 실행해줌.

- 관련 코드는 github 소스 코드 참고 (MemberRepositoryV5)

---

### 정리 및 회고

- 스프링에서 예외 처리와 반복을 어떻게 처리하는지 알게 되었으며, 이전에는 원리도 모른채 그냥 사용했을 것을 어떻게 적용하고 해결하는지 알게되었다.

---
